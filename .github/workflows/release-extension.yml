name: Sign Browser Extension & Create Release

on:
  workflow_dispatch:
    inputs:
      release_tag:
        description: "Git tag for the release"
        type: string
        required: true
      name:
        description: "Name of the release"
        type: string
        required: true
      make_latest:
        description: "Set this release as latest? (Not possible for drafts and prereleases)"
        type: choice
        options:
          - 'true'
          - 'false'
          - 'legacy'
        required: false
        default: 'true'
      draft:
        description: "Draft release?"
        type: boolean
        required: false
        default: false
      prerelease:
        description: "Prerelease?"
        type: boolean
        required: false
        default: false
      body:
        description: "Release body text"
        type: string
        required: false
        default: ""
      extension_dir:
        description: "Directory containing manifest.json"
        type: string
        required: false
        default: "extension"

jobs:
  sign-and-release:
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install web-ext
        run: npm install -g web-ext

      - name: Lint extension
        run: |
          web-ext lint \
            --source-dir "${{ github.event.inputs.extension_dir }}" \
            --ignore-files=lint-output.json \
            --self-hosted true \
            --output json > lint-output.json || true

          node -e '
            const fs = require("fs");
            const output = JSON.parse(fs.readFileSync("lint-output.json", "utf8"));

            console.log("\n=== web-ext lint results ===\n");

            console.log("metadata:", output.metadata, "\n" || "")

            const errors = output.errors || [];
            const warnings = output.warnings || [];
            const notices = output.notices || [];

            if (notices.length > 0) {
              console.log("Notices:");
              notices.forEach(n => console.log("  ℹ️", n.message));
              console.log("");
            }

            if (warnings.length > 0) {
              console.log("Warnings:");
              warnings.forEach(w => console.log("  ⚠️", w.message));
              console.log("");
            }

            if (errors.length > 0) {
              console.log("Errors:");
              errors.forEach(e => {
                console.log("  ❌", e.message);
              });
              console.log("");
            console.error("Build failed due to critical linting errors!");
              process.exit(1);
            } else {
              console.log("✅ Lint passed (no critical errors)");
            }
          '

      - name: Sign extension with web-ext
        env:
          WEB_EXT_API_KEY: ${{ secrets.AMO_JWT_ISSUER }}
          WEB_EXT_API_SECRET: ${{ secrets.AMO_JWT_SECRET }}
        run: |
          web-ext sign \
            --channel unlisted
            --source-dir "${{ github.event.inputs.extension_dir }}" \
            --artifacts-dir signed && \
          mv signed/*.xpi signed/btt-${{ github.event.inputs.release_tag }}.xpi

      - name: List signed artifact file
        run: ls -lh signed

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "v${{ github.event.inputs.release_tag }}"
          name: "v${{ github.event.inputs.release_tag }}: ${{ github.event.inputs.name }}"
          make_latest: "${{ github.event.inputs.make_latest }}"
          draft: "${{ github.event.inputs.draft }}"
          prerelease: "${{ github.event.inputs.prerelease }}"
          body: "${{ github.event.inputs.body }}"
          preserve_order: true
          files: "signed/btt-${{ github.event.inputs.release_tag }}.xpi"